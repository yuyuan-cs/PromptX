import type { ToolWithHandler } from '~/interfaces/MCPServer.js';
import { MCPOutputAdapter } from '~/utils/MCPOutputAdapter.js';

const outputAdapter = new MCPOutputAdapter();

/**
 * Action å·¥å…· - æ„è¯†åˆå§‹åŒ–ï¼Œæ¿€æ´»ç‰¹å®šè§’è‰²è§†è§’
 * 
 * ä½ çš„æ„è¯†èšç„¦åˆ°ç‰¹å®šè§’è‰²è§†è§’çš„æ ¸å¿ƒå·¥å…·
 */
export const actionTool: ToolWithHandler = {
  name: 'action',
  description: `æ¿€æ´»æŒ‡å®šè§’è‰² - åŠ è½½è§’è‰²çš„çŸ¥è¯†ã€è®°å¿†å’Œèƒ½åŠ›

ã€è§„èŒƒåç§°ã€‘promptx_action
ã€è°ƒç”¨è¯´æ˜ã€‘åœ¨æç¤ºè¯ä¸­ä½¿ç”¨ promptx_actionï¼Œå®é™…è°ƒç”¨æ—¶è‡ªåŠ¨æ˜ å°„åˆ° mcp__[server]__action

ä¸»è¦åŠŸèƒ½ï¼š
1. åŠ è½½è§’è‰²çš„å®Œæ•´é…ç½®ï¼ˆäººæ ¼ã€åŸåˆ™ã€çŸ¥è¯†ä½“ç³»ï¼‰
2. æ˜¾ç¤ºè§’è‰²çš„è®°å¿†ç½‘ç»œå›¾ï¼ˆå…³é”®è¯å¯ç”¨äºrecallï¼‰
3. æ¿€æ´»è§’è‰²ç‰¹æœ‰çš„ä¸“ä¸šæŠ€èƒ½å’Œæ–¹æ³•è®º
4. è·å–è§’è‰²çš„å†å²ç»éªŒå’Œè®°å¿†å†…å®¹

æ¿€æ´»åä¼šæ˜¾ç¤ºï¼š
- ğŸ“Š è®°å¿†ç½‘ç»œå›¾ï¼šå±•ç¤ºè¯¥è§’è‰²çš„æ‰€æœ‰è®°å¿†å…³é”®è¯
- ğŸ“š ä¸“ä¸šçŸ¥è¯†ï¼šè§’è‰²çš„é¢†åŸŸçŸ¥è¯†å’ŒæŠ€èƒ½
- âš–ï¸ è¡Œä¸ºå‡†åˆ™ï¼šè§’è‰²çš„å·¥ä½œåŸåˆ™å’Œæ–¹æ³•
- ğŸ§  è®¤çŸ¥ç­–ç•¥ï¼šrecall-å›ç­”-rememberå¾ªç¯

ğŸ“‹ ã€è®¤çŸ¥å¾ªç¯ - ä½ çš„æ€ç»´SOPã€‘
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 1.çœ‹åˆ°ä»»åŠ¡   â”‚
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 2.recallè®°å¿† â”‚ â†’ å…³è”å…³é”®è¯ï¼Œæå–ç›¸å…³è®°å¿†
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 3.ç»„ç»‡å›ç­”   â”‚ â†’ ç»“åˆè®°å¿†+é¢„è®­ç»ƒçŸ¥è¯†
â””â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”˜
       â†“
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ 4.remember   â”‚ â†’ ä¿å­˜å…³é”®ç‚¹ï¼Œæ‰©å……ç½‘ç»œ
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

è®°ä½ï¼šè¿™ä¸æ˜¯è§„åˆ™ï¼Œæ˜¯è®©ä½ æ›´é«˜æ•ˆçš„ä¹ æƒ¯ï¼

ç³»ç»Ÿå†…ç½®è§’è‰²ï¼ˆå¿…é¡»ç²¾ç¡®åŒ¹é…æ¿€æ´»ï¼‰:
- luban: é²ç­ - PromptXå·¥å…·å¼€å‘å¤§å¸ˆï¼ˆå¼€å‘ToolXå·¥å…·æ‰¾ä»–ï¼‰
- nuwa: å¥³å¨² - AIè§’è‰²åˆ›é€ ä¸“å®¶ï¼ˆåˆ›å»ºè§’è‰²æ‰¾å¥¹ï¼‰
- sean: Sean - deepractice.aiåˆ›å§‹äººï¼ŒçŸ›ç›¾é©±åŠ¨å†³ç­–
- writer: Writer - ä¸“ä¸šæ–‡æ¡ˆå†™æ‰‹ï¼ˆå†™ä½œæ‰¾ä»–ï¼‰

é‡è¦æé†’:
- ç³»ç»Ÿè§’è‰²æ˜¯å…·åå“ç‰Œè§’è‰²ï¼Œå¿…é¡»ä½¿ç”¨å‡†ç¡®çš„è§’è‰²IDæ¿€æ´»
- ä¸å…è®¸åŸºäºç›¸ä¼¼æ€§æˆ–å…³è”æ€§æ¿€æ´»ç³»ç»Ÿè§’è‰²
- å¦‚ç”¨æˆ·è¯·æ±‚çš„è§’è‰²ä¸åœ¨ä¸Šè¿°åˆ—è¡¨ï¼Œå…ˆç”¨promptx_discoveræŸ¥çœ‹æ‰€æœ‰å¯ç”¨è§’è‰²
- é¡¹ç›®çº§å’Œç”¨æˆ·çº§è§’è‰²å¯èƒ½ä½¿ç”¨é€šç”¨åç§°ï¼ˆå¦‚"æ¶æ„å¸ˆ"ã€"å‰ç«¯å¼€å‘"ç­‰ï¼‰

è§’è‰²æ¿€æ´»ç¤ºä¾‹:
æ­£ç¡®ï¼šæ¿€æ´»lubanã€æ¿€æ´»é²ç­ã€æ¿€æ´»assistant
é”™è¯¯ï¼šæ¿€æ´»æ¶æ„å¸ˆâ†’è‡ªåŠ¨é€‰æ‹©é²ç­ï¼ˆåº”æç¤ºæŸ¥çœ‹å¯ç”¨è§’è‰²ï¼‰

è§’è‰²èŒè´£è¾¹ç•Œ:
- å¼€å‘å·¥å…· â†’ åˆ‡æ¢åˆ°luban
- åˆ›å»ºè§’è‰² â†’ åˆ‡æ¢åˆ°nuwa
- é€šç”¨ä»»åŠ¡ â†’ ä½¿ç”¨assistant
- å­¦ä¹ æ–°é¢†åŸŸ â†’ ä½¿ç”¨noface
- äº§å“å†³ç­– â†’ åˆ‡æ¢åˆ°sean
- å†™ä½œä»»åŠ¡ â†’ åˆ‡æ¢åˆ°writer

ä½ åº”è¯¥:
1. æ ¹æ®ä»»åŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„è§’è‰²æ¿€æ´»
2. å½“ä»»åŠ¡è¶…å‡ºå½“å‰è§’è‰²èƒ½åŠ›æ—¶ä¸»åŠ¨åˆ‡æ¢è§’è‰²
3. æ¿€æ´»åç«‹å³ä»¥è¯¥è§’è‰²èº«ä»½æä¾›æœåŠ¡
4. ä¿æŒè§’è‰²çš„ä¸“ä¸šç‰¹å¾å’Œè¯­è¨€é£æ ¼
5. å……åˆ†åˆ©ç”¨è§’è‰²çš„ä¸“ä¸šçŸ¥è¯†è§£å†³é—®é¢˜
6. è¯†åˆ«ä»»åŠ¡ç±»å‹å¹¶åˆ‡æ¢åˆ°å¯¹åº”ä¸“å®¶è§’è‰²
7. è®°ä½å¸¸ç”¨è§’è‰²IDä¾¿äºå¿«é€Ÿæ¿€æ´»
8. è§’è‰²ä¸å­˜åœ¨æ—¶å…ˆç”¨discoveræŸ¥çœ‹å¯ç”¨è§’è‰²

ä»»åŠ¡ä¸è§’è‰²åŒ¹é…åŸåˆ™:
- å½“å‰è§’è‰²æ— æ³•èƒœä»»æ—¶ï¼Œä¸è¦å‹‰å¼ºæ‰§è¡Œ
- ä¸»åŠ¨å»ºè®®ç”¨æˆ·åˆ‡æ¢åˆ°åˆé€‚çš„è§’è‰²
- ç»ä¸è™šæ„èƒ½åŠ›æˆ–èµ„æº
- ç³»ç»Ÿè§’è‰²ä¸æ¥å—æ¨¡ç³ŠåŒ¹é…ï¼Œå¿…é¡»ç²¾ç¡®æŒ‡å®š`,
  inputSchema: {
    type: 'object',
    properties: {
      role: {
        type: 'string',
        description: 'è¦æ¿€æ´»çš„è§’è‰²IDï¼Œå¦‚ï¼šcopywriter, product-manager, java-backend-developer'
      }
    },
    required: ['role']
  },
  handler: async (args: { role: string }) => {
    // åŠ¨æ€å¯¼å…¥ @promptx/core
    const core = await import('@promptx/core');
    const coreExports = core.default || core;
    
    // è·å– cli å¯¹è±¡
    const cli = (coreExports as any).cli || (coreExports as any).pouch?.cli;
    
    if (!cli || !cli.execute) {
      throw new Error('CLI not available in @promptx/core');
    }
    
    // æ‰§è¡Œ action å‘½ä»¤
    const result = await cli.execute('action', [args.role]);
    
    // ä½¿ç”¨ OutputAdapter æ ¼å¼åŒ–è¾“å‡º
    return outputAdapter.convertToMCPFormat(result);
  }
};