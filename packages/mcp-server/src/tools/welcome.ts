import type { ToolWithHandler } from '~/interfaces/MCPServer.js';
import { MCPOutputAdapter } from '~/utils/MCPOutputAdapter.js';

const outputAdapter = new MCPOutputAdapter();

/**
 * Discover å·¥å…· - å±•ç¤ºæ‰€æœ‰å¯ç”¨çš„AIä¸“ä¸šè§’è‰²å’Œå·¥å…·
 * 
 * ä¸ºAIæä¾›å®Œæ•´çš„ä¸“ä¸šæœåŠ¡é€‰é¡¹æ¸…å•ï¼ŒåŒ…æ‹¬å¯æ¿€æ´»çš„è§’è‰²å’Œå¯è°ƒç”¨çš„å·¥å…·ã€‚
 */
export const discoverTool: ToolWithHandler = {
  name: 'discover',
  description: `ğŸ¯ [æ¢ç´¢AIæ½œèƒ½] å‘ç°ä½ çš„AIå¯ä»¥æˆä¸ºä»€ä¹ˆ - æ¢ç´¢å¯ç”¨è§’è‰²ä¸å·¥å…·
ä¸ºAIæä¾›å®Œæ•´çš„ä¸“ä¸šæœåŠ¡é€‰é¡¹æ¸…å•ï¼ŒåŒ…æ‹¬å¯æ¿€æ´»çš„è§’è‰²å’Œå¯è°ƒç”¨çš„å·¥å…·ã€‚

ã€è§„èŒƒåç§°ã€‘promptx_discover
ã€è°ƒç”¨è¯´æ˜ã€‘åœ¨æç¤ºè¯ä¸­ä½¿ç”¨ promptx_discoverï¼Œå®é™…è°ƒç”¨æ—¶è‡ªåŠ¨æ˜ å°„åˆ° mcp__[server]__discover

ä½•æ—¶ä½¿ç”¨æ­¤å·¥å…·:
- åˆæ¬¡è¿›å…¥é¡¹ç›®äº†è§£å¯ç”¨çš„è§’è‰²å’Œå·¥å…·
- éœ€è¦ä¸“ä¸šèƒ½åŠ›ä½†ä¸çŸ¥é“æœ‰å“ªäº›è§’è‰²å¯é€‰
- å¯»æ‰¾åˆé€‚çš„å·¥å…·æ¥å®Œæˆç‰¹å®šä»»åŠ¡
- æƒ³è¦äº†è§£ç³»ç»Ÿçº§ã€ç”¨æˆ·çº§èµ„æº
- ä¸ç¡®å®šè¯¥æ¿€æ´»ä»€ä¹ˆè§’è‰²æˆ–ä½¿ç”¨ä»€ä¹ˆå·¥å…·
- å®šæœŸæŸ¥çœ‹æ–°å¢çš„è§’è‰²å’Œå·¥å…·
- å½“åˆ›å»ºäº†æ–°çš„è§’è‰²å’Œå·¥å…·æ—¶ï¼Œéœ€è¦å‘ç°åˆšè¢«åˆ›å»ºçš„èµ„æº

æ ¸å¿ƒå±•ç¤ºå†…å®¹:
- æ‰€æœ‰å¯æ¿€æ´»çš„ä¸“ä¸šè§’è‰²ï¼ˆæŒ‰æ¥æºåˆ†ç»„ï¼‰
- æ‰€æœ‰å¯è°ƒç”¨çš„åŠŸèƒ½å·¥å…·ï¼ˆé™„å¸¦ä½¿ç”¨æ‰‹å†Œï¼‰
- ç³»ç»Ÿçº§èµ„æºï¼ˆğŸ“¦ æ¥è‡ªPromptXæ ¸å¿ƒï¼‰
- ç”¨æˆ·çº§èµ„æºï¼ˆğŸ‘¤ ç”¨æˆ·è‡ªå®šä¹‰ï¼‰
- èµ„æºç»Ÿè®¡å’Œå¿«é€Ÿç´¢å¼•

é‡è¦æç¤º:
âš ï¸ é¡¹ç›®çº§èµ„æºéœ€è¦å…ˆä½¿ç”¨ project å·¥å…·ç»‘å®šé¡¹ç›®ç›®å½•æ‰èƒ½å‘ç°
- å¦‚æœéœ€è¦é¡¹ç›®ç‰¹æœ‰çš„è§’è‰²å’Œå·¥å…·ï¼Œè¯·å…ˆè°ƒç”¨ project å·¥å…·
- project å·¥å…·ä¼šè‡ªåŠ¨æ‰«æå¹¶æ³¨å†Œé¡¹ç›®çš„ .promptx/resource ç›®å½•

èµ„æºæ¥æºè¯´æ˜:
- ğŸ“¦ ç³»ç»Ÿè§’è‰²/å·¥å…·ï¼šPromptXå†…ç½®çš„é€šç”¨èµ„æº
- ğŸ—ï¸ é¡¹ç›®è§’è‰²/å·¥å…·ï¼šéœ€å…ˆç”¨projectå·¥å…·æ¿€æ´»ï¼ˆä½äºé¡¹ç›®çš„.promptx/resourceï¼‰
- ğŸ‘¤ ç”¨æˆ·è§’è‰²/å·¥å…·ï¼šç”¨æˆ·è‡ªå®šä¹‰åˆ›å»ºçš„èµ„æº

ä½ åº”è¯¥:
1. å¦‚æœåœ¨é¡¹ç›®ä¸­å·¥ä½œï¼Œå…ˆç”¨projectå·¥å…·ç»‘å®šé¡¹ç›®ï¼Œå†ç”¨discoveræŸ¥çœ‹æ‰€æœ‰èµ„æº
2. æ ¹æ®ä»»åŠ¡éœ€æ±‚é€‰æ‹©åˆé€‚çš„è§’è‰²æ¿€æ´»
3. å‘ç°å·¥å…·åé€šè¿‡manualé“¾æ¥å­¦ä¹ ä½¿ç”¨æ–¹æ³•
4. è®°ä½å¸¸ç”¨è§’è‰²IDå’Œå·¥å…·åä¾¿äºå¿«é€Ÿè°ƒç”¨
5. ä¸ºç”¨æˆ·æ¨èæœ€é€‚åˆå½“å‰ä»»åŠ¡çš„è§’è‰²æˆ–å·¥å…·
6. å…³æ³¨æ–°å¢èµ„æºï¼ˆç‰¹åˆ«æ˜¯é¡¹ç›®çº§å’Œç”¨æˆ·çº§ï¼‰
7. ç†è§£ä¸åŒæ¥æºèµ„æºçš„ä¼˜å…ˆçº§å’Œé€‚ç”¨åœºæ™¯
8. å·¥å…·ä½¿ç”¨å‰å¿…é¡»å…ˆlearnå…¶manualæ–‡æ¡£

èšç„¦å‚æ•°è¯´æ˜:
- 'all' (é»˜è®¤): å±•ç¤ºæ‰€æœ‰èµ„æº
- 'roles': ä»…å±•ç¤ºå¯æ¿€æ´»çš„è§’è‰²
- 'tools': ä»…å±•ç¤ºå¯ç”¨çš„å·¥å…·`,
  inputSchema: {
    type: 'object',
    properties: {
      focus: {
        type: 'string',
        description: "èšç„¦èŒƒå›´ï¼š'all'(æ‰€æœ‰)ã€'roles'(è§’è‰²)æˆ–'tools'(å·¥å…·)",
        enum: ['all', 'roles', 'tools'],
        default: 'all'
      }
    }
  },
  handler: async () => {
    // åŠ¨æ€å¯¼å…¥ @promptx/core
    const core = await import('@promptx/core');
    const coreExports = core.default || core;
    
    // è·å– cli å¯¹è±¡
    const cli = (coreExports as any).cli || (coreExports as any).pouch?.cli;
    
    if (!cli || !cli.execute) {
      throw new Error('CLI not available in @promptx/core');
    }
    
    // æ‰§è¡Œ discover å‘½ä»¤
    const result = await cli.execute('discover', []);
    
    // ä½¿ç”¨ OutputAdapter æ ¼å¼åŒ–è¾“å‡º
    return outputAdapter.convertToMCPFormat(result);
  }
};