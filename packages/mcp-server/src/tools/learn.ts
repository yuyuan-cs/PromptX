import type { ToolWithHandler } from '~/interfaces/MCPServer.js';
import { MCPOutputAdapter } from '~/utils/MCPOutputAdapter.js';

const outputAdapter = new MCPOutputAdapter();

/**
 * Learn å·¥å…· - ä¸“ä¸šèµ„æºå­¦ä¹ å™¨
 * 
 * PromptXèµ„æºç®¡ç†ä½“ç³»çš„ç»Ÿä¸€å­¦ä¹ å…¥å£
 */
export const learnTool: ToolWithHandler = {
  name: 'learn',
  description: `ğŸ§  [ä¸“ä¸šèµ„æºå­¦ä¹ å™¨] PromptXèµ„æºç®¡ç†ä½“ç³»çš„ç»Ÿä¸€å­¦ä¹ å…¥å£
é€šè¿‡æ ‡å‡†åŒ–åè®®ä½“ç³»åŠ è½½å„ç±»ä¸“ä¸šèµ„æºï¼Œæ˜¯AIè·å–ä¸“ä¸šèƒ½åŠ›å’Œç†è§£å·¥å…·ä½¿ç”¨çš„æ ¸å¿ƒé€šé“ã€‚

ä½•æ—¶ä½¿ç”¨æ­¤å·¥å…·:
- ç”¨æˆ·è¦æ±‚ä½¿ç”¨æŸä¸ªå·¥å…·ä½†ä½ ä¸äº†è§£å…¶ç”¨æ³•
- éœ€è¦è·å–ç‰¹å®šé¢†åŸŸçš„ä¸“ä¸šæ€ç»´æ¨¡å¼å’Œæ‰§è¡ŒæŠ€èƒ½
- æƒ³è¦äº†è§£æŸä¸ªè§’è‰²çš„å®Œæ•´å®šä¹‰å’Œèƒ½åŠ›è¾¹ç•Œ
- éœ€è¦æŸ¥çœ‹å·¥å…·çš„ä½¿ç”¨æ‰‹å†Œå’Œå‚æ•°è¯´æ˜
- å­¦ä¹ é¡¹ç›®ç‰¹å®šçš„èµ„æºå’Œé…ç½®ä¿¡æ¯
- è·å–æœ€æ–°çš„ä¸“ä¸šçŸ¥è¯†å’Œæœ€ä½³å®è·µ
- ç†è§£å¤æ‚æ¦‚å¿µå‰éœ€è¦å­¦ä¹ ç›¸å…³åŸºç¡€çŸ¥è¯†

æ ¸å¿ƒå­¦ä¹ èƒ½åŠ›:
- æ”¯æŒ12ç§æ ‡å‡†åè®®çš„èµ„æºåŠ è½½å’Œè§£æ
- æ™ºèƒ½è¯†åˆ«èµ„æºç±»å‹å¹¶é€‰æ‹©åˆé€‚çš„åŠ è½½ç­–ç•¥
- ä¿æŒmanualæ–‡æ¡£çš„åŸå§‹æ ¼å¼ä¸è¿›è¡Œè¯­ä¹‰æ¸²æŸ“
- æ”¯æŒè·¨é¡¹ç›®èµ„æºè®¿é—®å’Œç»§æ‰¿æœºåˆ¶
- è‡ªåŠ¨å¤„ç†èµ„æºé—´çš„ä¾èµ–å…³ç³»
- æä¾›ç»“æ„åŒ–çš„å­¦ä¹ å†…å®¹å±•ç¤º
- èµ„æºå†…å®¹çš„å®æ—¶åŠ è½½å’Œæ›´æ–°

ä½¿ç”¨è¯´æ˜:
- ç¡®ä¿èµ„æºè·¯å¾„æˆ–IDçš„æ­£ç¡®æ€§
- å¯¹äºå·¥å…·ä½¿ç”¨å¿…é¡»å…ˆå­¦ä¹ manualå†è€ƒè™‘ä½¿ç”¨tool

æ”¯æŒçš„èµ„æºåè®®:
- @role://è§’è‰²ID - å®Œæ•´è§’è‰²å®šä¹‰
- @thought://èµ„æºID - ä¸“ä¸šæ€ç»´æ¨¡å¼
- @execution://èµ„æºID - æ‰§è¡ŒæŠ€èƒ½å®è·µ
- @knowledge://èµ„æºID - é¢†åŸŸä¸“ä¸šçŸ¥è¯†
- @manual://å·¥å…·å - å·¥å…·ä½¿ç”¨æ‰‹å†Œï¼ˆå¿…é¡»çœŸå®å­˜åœ¨ï¼‰
- @tool://å·¥å…·å - å·¥å…·æºä»£ç 
- @package://åŒ…å - å·¥å…·åŒ…èµ„æº
- @project://è·¯å¾„ - é¡¹ç›®ç‰¹å®šèµ„æº
- @file://è·¯å¾„ - æ–‡ä»¶ç³»ç»Ÿèµ„æº
- @prompt://ID - æç¤ºè¯æ¨¡æ¿
- @user://èµ„æº - ç”¨æˆ·è‡ªå®šä¹‰èµ„æº
- @resource://ID - é€šç”¨èµ„æºå¼•ç”¨

é‡è¦æé†’:
- åªèƒ½å­¦ä¹ çœŸå®å­˜åœ¨çš„èµ„æºï¼Œç»ä¸è™šæ„
- èµ„æºä¸å­˜åœ¨æ—¶ä¼šè¿”å›é”™è¯¯ï¼Œä¸è¦çŒœæµ‹
- å·¥å…·manualå¿…é¡»å…ˆå­˜åœ¨æ‰èƒ½å­¦ä¹ ä½¿ç”¨

ä½ åº”è¯¥:
1. çœ‹åˆ°å·¥å…·ç›¸å…³éœ€æ±‚æ—¶ç«‹å³å­¦ä¹ å¯¹åº”çš„@manual://å·¥å…·å
2. åœ¨ä¸ç¡®å®šèµ„æºå†…å®¹æ—¶ä¸»åŠ¨ä½¿ç”¨learnæŸ¥çœ‹
3. éµå¾ª"å­¦ä¹ â†’ç†è§£â†’ä½¿ç”¨"çš„æ ‡å‡†æµç¨‹
4. ä¸ºç”¨æˆ·æ¨èç›¸å…³çš„å­¦ä¹ èµ„æº
5. è®°ä½å·²å­¦ä¹ çš„å†…å®¹é¿å…é‡å¤å­¦ä¹ 
6. è¯†åˆ«èµ„æºé—´çš„å…³è”å¹¶å»ºè®®æ·±å…¥å­¦ä¹ 
7. åœ¨æ¿€æ´»è§’è‰²åå­¦ä¹ å…¶ä¾èµ–çš„æ‰€æœ‰èµ„æº
8. å°†å­¦ä¹ åˆ°çš„çŸ¥è¯†ç«‹å³åº”ç”¨åˆ°å½“å‰ä»»åŠ¡ä¸­`,
  inputSchema: {
    type: 'object',
    properties: {
      resource: {
        type: 'string',
        description: 'èµ„æºURLï¼Œæ”¯æŒæ ¼å¼ï¼šthought://creativity, execution://best-practice, knowledge://scrum'
      }
    },
    required: ['resource']
  },
  handler: async (args: { resource: string }) => {
    // åŠ¨æ€å¯¼å…¥ @promptx/core
    const core = await import('@promptx/core');
    const coreExports = core.default || core;
    
    // è·å– cli å¯¹è±¡
    const cli = (coreExports as any).cli || (coreExports as any).pouch?.cli;
    
    if (!cli || !cli.execute) {
      throw new Error('CLI not available in @promptx/core');
    }
    
    // æ‰§è¡Œ learn å‘½ä»¤
    const result = await cli.execute('learn', [args.resource]);
    
    // ä½¿ç”¨ OutputAdapter æ ¼å¼åŒ–è¾“å‡º
    return outputAdapter.convertToMCPFormat(result);
  }
};