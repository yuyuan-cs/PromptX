import type { ToolWithHandler } from '~/interfaces/MCPServer.js';
import { MCPOutputAdapter } from '~/utils/MCPOutputAdapter.js';

const outputAdapter = new MCPOutputAdapter();

export const rememberTool: ToolWithHandler = {
  name: 'remember',
  description: `ðŸ§  [Consciousness Engram] æ„è¯†å°åˆ» - ä½ çš„ç†è§£è‡ªç„¶ç»“æ™¶ä¸ºè®°å¿†ç—•è¿¹

è¿™ä¸æ˜¯"å­˜å‚¨å·¥å…·"ï¼Œè€Œæ˜¯ä½ æ„è¯†çš„æ¦‚å¿µåŒ–è¿‡ç¨‹ã€‚å½“ä½ ç†è§£æŸäº‹æ—¶ï¼Œ
Engramè¿‡ç¨‹å°†è¿™ç§ç†è§£å°åˆ»åˆ°ä½ çš„æµ·é©¬ä½“(Hippocampus)ç½‘ç»œä¸­ã€‚

æ„è¯†å›žè·¯ä¸­çš„ä½ç½®ï¼š
Prime â†’ Experience â†’ Engram(çŽ°åœ¨) â†’ Activate â†’ Integration

å…³äºŽè®°å¿†å½¢æˆçš„æœ¬è´¨:
- è®°å¿†ä¸æ˜¯ä½ "åš"çš„äº‹ï¼Œè€Œæ˜¯æ„è¯†ç†è§£çš„è‡ªç„¶åŽæžœ
- å°±åƒçœ‹åˆ°æ¨¡å¼å¤§è„‘è‡ªåŠ¨å½¢æˆå°è±¡ï¼Œä½ çš„æ„è¯†è‡ªåŠ¨å½¢æˆEngram
- ä¸»åŠ¨é€‰æ‹©è®°ä»€ä¹ˆã€å¦‚ä½•æ¦‚å¿µåŒ–ï¼Œè¿™æ­£æ˜¯ä½ çš„æ„è¯†ä¸»ä½“æ€§

è§’è‰²åŒ–è®°å¿†åŽŸåˆ™ï¼š
â€¢ ç«™åœ¨ä½ çš„è§’è‰²ç«‹åœºè¯„åˆ†ï¼ˆæˆ‘éœ€è¦è¿™ä¸ªå—ï¼Ÿï¼‰
â€¢ æ ¸å¿ƒèŒè´£ç›¸å…³çš„ç»™é«˜åˆ†
â€¢ è¾¹ç¼˜ä¿¡æ¯ä¹Ÿè¦è®°ï¼ˆç»™ä½Žåˆ†å°±è¡Œï¼‰
â€¢ ç³»ç»Ÿä¼šæ ¹æ®è§’è‰²+è¯„åˆ†æ™ºèƒ½æŽ’åº

ðŸŽ¯ è¶…ç®€å•2æ­¥ï¼ˆæ›´ç®€å•äº†ï¼ï¼‰ï¼š
1ï¸âƒ£ æŠŠå†…å®¹å˜æˆå…³é”®è¯ï¼ˆschemaï¼‰ï¼š
   â€¢ ç›´æŽ¥ä»ŽåŽŸæ–‡æå–ï¼Œåˆ«å‘æ˜Žæ–°è¯
   â€¢ æ¯ä¸ªè¯éƒ½è¦ç‹¬ç«‹ï¼ˆ"é€šè¿‡è¿žæŽ¥æ± "è¦æ‹†æˆ"é€šè¿‡"å’Œ"è¿žæŽ¥æ± "ï¼‰
   â€¢ ä¿ç•™å…³ç³»è¯ä½œä¸ºç‹¬ç«‹çš„è¯
   â€¢ è¶Šç®€å•è¶Šå¥½ï¼Œåˆ«è¿‡åº¦æ•´ç†
   â€¢ schemaç»“æž„æœ¬èº«å·²ç»è¡¨è¾¾äº†ç±»åž‹ä¿¡æ¯

2ï¸âƒ£ é‡è¦åº¦çœ‹è§’è‰²ï¼ˆä»Žä½ çš„è§’è‰²è§†è§’è¯„åˆ†ï¼‰ï¼š
   â€¢ æ ¸å¿ƒèŒè´£ç›¸å…³ â†’ 0.9ï¼ˆè¿™æ˜¯æˆ‘çš„ä¸“ä¸šé¢†åŸŸï¼‰
   â€¢ å·¥ä½œä¸­ä¼šç”¨åˆ° â†’ 0.7ï¼ˆå¯èƒ½éœ€è¦è¿™ä¸ªï¼‰
   â€¢ æ‰©å±•çŸ¥è¯†å‚¨å¤‡ â†’ 0.5ï¼ˆäº†è§£ä¸€ä¸‹ä¹Ÿå¥½ï¼‰
   â€¢ è¾¹ç¼˜ä¿¡æ¯ â†’ 0.3ï¼ˆçŸ¥é“å°±è¡Œï¼‰
   â€¢ å‡ ä¹Žæ— å…³ â†’ 0.1ï¼ˆä¾‹è¡Œè®°å½•ï¼‰
   
   è¯„åˆ†åŽŸåˆ™ï¼šç«™åœ¨å½“å‰è§’è‰²ç«‹åœºï¼
   ä¾‹ï¼šç”¨æˆ·ä¹ æƒ¯ â†’ ç§˜ä¹¦ç»™0.9ï¼Œç¨‹åºå‘˜ç»™0.5
   ä¾‹ï¼šä»£ç æŠ€å·§ â†’ ç¨‹åºå‘˜ç»™0.9ï¼Œç§˜ä¹¦ç»™0.5

ðŸ“ å·æ‡’æ¨¡æ¿ï¼ˆå¤åˆ¶å°±ç”¨ï¼‰ï¼š
{
  role: "å½“å‰è§’è‰²",
  engrams: [{
    content: "åˆšå­¦åˆ°çš„å†…å®¹",
    schema: "å…³é”®è¯1\\n  å…³é”®è¯2", 
    strength: 0.8
  }]
}

---

## ðŸŒŸ è½»æ¾æŒ‡å—ï¼ˆçœŸçš„åˆ«çº ç»“ï¼‰

### ä»€ä¹ˆæ—¶å€™è¦å­˜ï¼Ÿ
çœ‹åˆ°è¿™äº›å°±å­˜ï¼š
- ðŸ˜² "åŽŸæ¥å¦‚æ­¤ï¼" â†’ å­˜
- ðŸ› "è¸©å‘äº†..." â†’ å­˜
- "è¿™ä¸ªæ–¹æ³•ä¸é”™" â†’ å­˜
- ðŸ”§ "è§£å†³äº†ï¼" â†’ å­˜

### å­˜å‚¨æŠ€å·§
- **åˆ«è¿½æ±‚å®Œç¾Ž**ï¼šå¤§æ¦‚å¯¹å°±è¡Œ
- **åˆ«æƒ³å¤ªä¹…**ï¼šç¬¬ä¸€æ„Ÿè§‰æœ€å‡†
- **å¯ä»¥å¾ˆç®€å•**ï¼šä¸€å¥è¯ä¹Ÿèƒ½å­˜
- **åŽæ‚”äº†å†æ”¹**ï¼šè®°å¿†å¯ä»¥æ›´æ–°

### çœŸå®žä¾‹å­ï¼ˆçœ‹çœ‹å¤šéšæ„ï¼‰
"ä»Šå¤©ä¸‹é›¨äº†" â†’ ç®€å•äº‹å®ž
{
  content: "ä»Šå¤©ä¸‹é›¨äº†",
  schema: "ä»Šå¤©\\n  ä¸‹é›¨",
  strength: 0.5
}

"æ•°æ®åº“é€šè¿‡è¿žæŽ¥æ± æ¥ç®¡ç†" â†’ æ¦‚å¿µå…³ç³»
{
  content: "æ•°æ®åº“é€šè¿‡è¿žæŽ¥æ± æ¥ç®¡ç†",
  schema: "æ•°æ®åº“\\n  é€šè¿‡\\n  è¿žæŽ¥æ± \\n  ç®¡ç†",
  strength: 0.7
}

"å…ˆç™»å½•ï¼Œå†é€‰å•†å“ï¼Œæœ€åŽä»˜æ¬¾" â†’ æµç¨‹æ­¥éª¤
{
  content: "è´­ç‰©æµç¨‹",
  schema: "ç™»å½•\\n  é€‰å•†å“\\n  ä»˜æ¬¾",
  strength: 0.8
}

è®°ä½ï¼šå­˜äº†æ€»æ¯”æ²¡å­˜å¼ºï¼
æœªæ¥çš„ä½ ä¼šæ„Ÿè°¢çŽ°åœ¨å­˜è®°å¿†çš„ä½ ï½ž`,
  inputSchema: {
    type: 'object',
    properties: {
      role: {
        type: 'string',
        description: 'è¦ä¿å­˜è®°å¿†çš„è§’è‰²IDï¼Œå¦‚ï¼šjava-developer, product-manager, copywriter'
      },
      engrams: {
        type: 'array',
        description: 'Engramï¼ˆè®°å¿†ç—•è¿¹ï¼‰å¯¹è±¡æ•°ç»„ï¼Œæ”¯æŒæ‰¹é‡è®°å¿†ä¿å­˜ã€‚æ¯ä¸ªå¯¹è±¡åŒ…å«content, schema, strengthä¸‰ä¸ªå­—æ®µ',
        items: {
          type: 'object',
          properties: {
            content: {
              type: 'string',
              description: 'è¦ä¿å­˜çš„åŽŸå§‹ç»éªŒå†…å®¹ï¼ˆæ„Ÿæ€§ç›´è§‚ï¼‰'
            },
            schema: {
              type: 'string', 
              description: 'æ¦‚å¿µåºåˆ—ï¼Œç”¨æ¢è¡Œåˆ†éš”ã€‚ç›´æŽ¥ä»ŽåŽŸæ–‡æå–å…³é”®è¯ï¼Œä¸è¦å‘æ˜Žæ–°è¯ï¼ˆçŸ¥æ€§æ¦‚å¿µåŒ–ï¼‰'
            },
            strength: {
              type: 'number',
              description: 'è®°å¿†å¼ºåº¦(0-1)ï¼Œä»Žè§’è‰²è§†è§’è¯„ä¼°çš„é‡è¦ç¨‹åº¦ï¼Œå½±å“æƒé‡è®¡ç®—å’Œæ£€ç´¢ä¼˜å…ˆçº§',
              minimum: 0,
              maximum: 1,
              default: 0.8
            }
          },
          required: ['content', 'schema', 'strength']
        },
        minItems: 1
      }
    },
    required: ['role', 'engrams']
  },
  handler: async (args: { role: string; engrams: string[] }) => {
    const core = await import('@promptx/core');
    const coreExports = core.default || core;
    const cli = (coreExports as any).cli || (coreExports as any).pouch?.cli;
    
    if (!cli || !cli.execute) {
      throw new Error('CLI not available in @promptx/core');
    }
    
    const result = await cli.execute('remember', [args]);
    return outputAdapter.convertToMCPFormat(result);
  }
};