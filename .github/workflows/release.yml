name: Release

on:
  push:
    branches:
      - main
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Dry run (no actual publish)'
        type: boolean
        required: false
        default: true
      release_type:
        description: 'Release type'
        type: choice
        required: true
        default: 'alpha'
        options:
          - alpha
          - beta
          - latest

permissions:
  contents: write
  packages: write
  pull-requests: write

jobs:
  release:
    name: Release
    runs-on: ubuntu-latest
    # é˜²æ­¢åœ¨æœ¬åœ°æµ‹è¯•æ—¶æ„å¤–å‘å¸ƒ
    if: ${{ github.event_name != 'pull_request' }}
    
    steps:
    - name: ğŸ“¥ Checkout
      uses: actions/checkout@v4
      with:
        fetch-depth: 0
        token: ${{ secrets.GITHUB_TOKEN }}
    
    - name: ğŸ”§ Setup pnpm
      uses: pnpm/action-setup@v2
      with:
        version: 8
    
    - name: ğŸ”§ Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: 20
        registry-url: 'https://registry.npmjs.org'
        cache: 'pnpm'
    
    - name: ğŸ“¦ Install dependencies
      run: pnpm install --frozen-lockfile
      env:
        HUSKY: 0
    
    - name: ğŸ—ï¸ Build
      run: pnpm build || echo "No build script"
    
    # Dry run æµ‹è¯•
    - name: ğŸ§ª Test Release (Dry Run)
      if: ${{ inputs.dry_run == true || env.IS_LOCAL_TEST == 'true' }}
      run: |
        echo "ğŸ§ª Running in dry-run mode - NO ACTUAL PUBLISH"
        echo "Release type: ${{ inputs.release_type || 'alpha' }}"
        
        # æµ‹è¯•changesetç‰ˆæœ¬
        pnpm changeset status || echo "No changesets found"
        
        # æµ‹è¯•npmå‘å¸ƒï¼ˆä¸ä¼šçœŸçš„å‘å¸ƒï¼‰
        npm publish --dry-run
        
        echo "âœ… Dry run completed successfully"
    
    # çœŸå®å‘å¸ƒï¼ˆéœ€è¦å¤šé‡æ¡ä»¶ï¼‰
    - name: ğŸš€ Create Release
      if: |
        inputs.dry_run == false && 
        github.event_name == 'workflow_dispatch' &&
        github.ref == 'refs/heads/main' &&
        !env.IS_LOCAL_TEST &&
        !env.ACT
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        NODE_AUTH_TOKEN: ${{ secrets.NPM_TOKEN }}
      run: |
        echo "ğŸš€ Publishing ${{ inputs.release_type }} release"
        
        # é…ç½®git
        git config user.name "github-actions[bot]"
        git config user.email "github-actions[bot]@users.noreply.github.com"
        
        # æ ¹æ®ç±»å‹å‘å¸ƒ
        if [ "${{ inputs.release_type }}" = "latest" ]; then
          pnpm changeset publish
        else
          pnpm changeset version --snapshot ${{ inputs.release_type }}
          pnpm changeset publish --tag ${{ inputs.release_type }}
        fi
    
    - name: ğŸ“Š Release Summary
      if: always()
      run: |
        echo "### Release Summary"
        echo "- Dry Run: ${{ inputs.dry_run == true || env.IS_LOCAL_TEST == 'true' }}"
        echo "- Release Type: ${{ inputs.release_type || 'N/A' }}"
        echo "- Branch: ${{ github.ref }}"
        echo "- Local Test: ${{ env.IS_LOCAL_TEST || 'false' }}"
        echo "- Act Environment: ${{ env.ACT || 'false' }}"