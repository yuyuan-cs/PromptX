name: Workflow Sync via PR

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to sync workflows'
        required: true
        type: choice
        options:
          - main
          - test
          - staging
      sync_mode:
        description: 'Sync mode'
        required: true
        type: choice
        options:
          - all         # åŒæ­¥æ‰€æœ‰å·¥ä½œæµ
          - selective   # åªåŒæ­¥ç‰¹å®šå·¥ä½œæµ
      workflow_files:
        description: 'Workflow files to sync (only for selective mode, comma-separated)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  create-sync-pr:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || github.token }}
          
      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Create sync branch
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          SYNC_BRANCH="workflow-sync/${{ github.event.inputs.target_branch }}-$TIMESTAMP"
          echo "SYNC_BRANCH=$SYNC_BRANCH" >> $GITHUB_ENV
          
          # ä»ç›®æ ‡åˆ†æ”¯åˆ›å»ºæ–°åˆ†æ”¯
          git checkout -b "$SYNC_BRANCH" "origin/${{ github.event.inputs.target_branch }}"
          
      - name: Sync workflow files
        run: |
          if [ "${{ github.event.inputs.sync_mode }}" = "all" ]; then
            echo "ğŸ“‹ Syncing all workflow files..."
            # ä» develop å¤åˆ¶æ‰€æœ‰å·¥ä½œæµ
            git checkout develop -- .github/workflows/
            git checkout develop -- .github/*.yml 2>/dev/null || true
            git checkout develop -- .github/*.yaml 2>/dev/null || true
            
            # è®°å½•åŒæ­¥çš„æ–‡ä»¶
            SYNCED_FILES=$(git diff --name-only | grep -E '^\.github/' || echo "No changes")
            echo "SYNCED_FILES<<EOF" >> $GITHUB_ENV
            echo "$SYNCED_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          else
            echo "ğŸ“‹ Syncing selective workflow files..."
            # è§£æé€‰æ‹©çš„æ–‡ä»¶
            IFS=',' read -ra FILES <<< "${{ github.event.inputs.workflow_files }}"
            SYNCED_FILES=""
            
            for file in "${FILES[@]}"; do
              file=$(echo "$file" | xargs) # å»é™¤ç©ºæ ¼
              if [ -n "$file" ]; then
                # ç¡®ä¿æ–‡ä»¶è·¯å¾„æ­£ç¡®
                if [[ ! "$file" =~ ^\.github/ ]]; then
                  file=".github/workflows/$file"
                fi
                
                # ä» develop å¤åˆ¶ç‰¹å®šæ–‡ä»¶
                if git checkout develop -- "$file" 2>/dev/null; then
                  SYNCED_FILES="${SYNCED_FILES}${file}\n"
                  echo "âœ… Synced: $file"
                else
                  echo "âš ï¸ File not found: $file"
                fi
              fi
            done
            
            echo "SYNCED_FILES<<EOF" >> $GITHUB_ENV
            echo -e "$SYNCED_FILES" >> $GITHUB_ENV
            echo "EOF" >> $GITHUB_ENV
          fi
          
      - name: Check for changes
        id: check-changes
        run: |
          if git diff --quiet; then
            echo "has_changes=false" >> $GITHUB_OUTPUT
            echo "âœ… No changes detected - workflows are already in sync"
          else
            echo "has_changes=true" >> $GITHUB_OUTPUT
            echo "ğŸ“ Changes detected, preparing to create PR"
          fi
          
      - name: Commit changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git add .github/
          git commit -m "chore: åŒæ­¥å·¥ä½œæµä» develop åˆ° ${{ github.event.inputs.target_branch }}

åŒæ­¥æ¨¡å¼: ${{ github.event.inputs.sync_mode }}
è§¦å‘è€…: @${{ github.actor }}

åŒæ­¥çš„æ–‡ä»¶:
${{ env.SYNCED_FILES }}"
          
      - name: Push changes
        if: steps.check-changes.outputs.has_changes == 'true'
        run: |
          git push origin "${{ env.SYNC_BRANCH }}"
          
      - name: Create Pull Request
        if: steps.check-changes.outputs.has_changes == 'true'
        id: create-pr
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || github.token }}
          script: |
            const syncedFiles = `${{ env.SYNCED_FILES }}`.trim().split('\n').filter(f => f);
            const fileList = syncedFiles.map(f => `- \`${f}\``).join('\n');
            
            const body = `## ğŸ”„ å·¥ä½œæµåŒæ­¥è¯·æ±‚

### ğŸ“‹ åŒæ­¥è¯¦æƒ…
- **æºåˆ†æ”¯**: \`develop\`
- **ç›®æ ‡åˆ†æ”¯**: \`${{ github.event.inputs.target_branch }}\`
- **åŒæ­¥æ¨¡å¼**: ${{ github.event.inputs.sync_mode }}
- **è§¦å‘è€…**: @${{ github.actor }}

### ğŸ“ åŒæ­¥çš„æ–‡ä»¶
${fileList || 'æ— æ–‡ä»¶å˜æ›´'}

### âœ… æ£€æŸ¥æ¸…å•
- [ ] ç¡®è®¤å·¥ä½œæµå˜æ›´ç¬¦åˆé¢„æœŸ
- [ ] ç¡®è®¤ä¸ä¼šç ´åç›®æ ‡åˆ†æ”¯çš„ç‰¹å®šé…ç½®
- [ ] ç¡®è®¤æ‰€æœ‰å¿…éœ€çš„ secrets åœ¨ç›®æ ‡ç¯å¢ƒå¯ç”¨

### ğŸš€ åˆå¹¶å½±å“
åˆå¹¶åï¼Œ\`${{ github.event.inputs.target_branch }}\` åˆ†æ”¯å°†è·å¾—æœ€æ–°çš„å·¥ä½œæµæ›´æ–°ã€‚

---
*æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`;
            
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `chore: åŒæ­¥å·¥ä½œæµåˆ° ${{ github.event.inputs.target_branch }} åˆ†æ”¯`,
              body: body,
              head: '${{ env.SYNC_BRANCH }}',
              base: '${{ github.event.inputs.target_branch }}',
              draft: false
            });
            
            // æ·»åŠ æ ‡ç­¾
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              labels: ['workflow-sync', 'automated']
            });
            
            console.log(`âœ… Created PR #${pr.number}: ${pr.html_url}`);
            return pr.number;
            
      - name: Summary
        if: always()
        run: |
          echo "## ğŸ”„ å·¥ä½œæµåŒæ­¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ steps.check-changes.outputs.has_changes }}" = "true" ]; then
            echo "âœ… **çŠ¶æ€**: æˆåŠŸåˆ›å»ºåŒæ­¥ PR" >> $GITHUB_STEP_SUMMARY
            echo "ğŸ“ **PR**: #${{ steps.create-pr.outputs.result }}" >> $GITHUB_STEP_SUMMARY
          else
            echo "â„¹ï¸ **çŠ¶æ€**: æ— éœ€åŒæ­¥ï¼ˆå·¥ä½œæµå·²æ˜¯æœ€æ–°ï¼‰" >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### åŒæ­¥é…ç½®" >> $GITHUB_STEP_SUMMARY
          echo "- **ç›®æ ‡åˆ†æ”¯**: ${{ github.event.inputs.target_branch }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒæ­¥æ¨¡å¼**: ${{ github.event.inputs.sync_mode }}" >> $GITHUB_STEP_SUMMARY
          
          if [ "${{ github.event.inputs.sync_mode }}" = "selective" ]; then
            echo "- **æŒ‡å®šæ–‡ä»¶**: ${{ github.event.inputs.workflow_files }}" >> $GITHUB_STEP_SUMMARY
          fi