name: Sync Workflows

on:
  push:
    branches:
      - develop
    paths:
      - '.github/workflows/**'
      - '.github/*.yml'
      - '.github/*.yaml'
  
  workflow_dispatch:
    inputs:
      sync_method:
        description: 'åŒæ­¥æ–¹å¼'
        required: true
        type: choice
        default: 'auto'
        options:
          - auto      # æ ¹æ®åˆ†æ”¯ä¿æŠ¤è§„åˆ™è‡ªåŠ¨é€‰æ‹©
          - direct    # ç›´æ¥pushï¼ˆé€‚ç”¨äºæ— ä¿æŠ¤åˆ†æ”¯ï¼‰
          - pr        # åˆ›å»ºPRï¼ˆé€‚ç”¨äºæœ‰ä¿æŠ¤åˆ†æ”¯ï¼‰
      target_branches:
        description: 'ç›®æ ‡åˆ†æ”¯ (é€—å·åˆ†éš”ï¼Œå¦‚: test,staging,main)'
        required: false
        default: 'test,staging,main'
        type: string
      sync_mode:
        description: 'åŒæ­¥å†…å®¹'
        required: true
        type: choice
        default: 'all'
        options:
          - all         # åŒæ­¥æ‰€æœ‰å·¥ä½œæµ
          - selective   # åªåŒæ­¥ç‰¹å®šå·¥ä½œæµ
      workflow_files:
        description: 'æŒ‡å®šè¦åŒæ­¥çš„æ–‡ä»¶ (selectiveæ¨¡å¼ä½¿ç”¨ï¼Œé€—å·åˆ†éš”)'
        required: false
        type: string

permissions:
  contents: write
  pull-requests: write

jobs:
  sync-workflows:
    runs-on: ubuntu-latest
    
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || github.token }}
          
      - name: Set up Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Determine parameters
        id: params
        run: |
          # ç¡®å®šç›®æ ‡åˆ†æ”¯
          if [ "${{ github.event_name }}" = "workflow_dispatch" ]; then
            BRANCHES="${{ github.event.inputs.target_branches }}"
            SYNC_METHOD="${{ github.event.inputs.sync_method }}"
            SYNC_MODE="${{ github.event.inputs.sync_mode }}"
          else
            # è‡ªåŠ¨è§¦å‘æ—¶çš„é»˜è®¤å€¼
            BRANCHES="test,staging,main"
            SYNC_METHOD="auto"
            SYNC_MODE="all"
          fi
          
          echo "branches=$BRANCHES" >> $GITHUB_OUTPUT
          echo "sync_method=$SYNC_METHOD" >> $GITHUB_OUTPUT
          echo "sync_mode=$SYNC_MODE" >> $GITHUB_OUTPUT
          
      - name: Get changed files (for push event)
        id: changed-files
        if: github.event_name == 'push'
        run: |
          CHANGED_FILES=$(git diff --name-only HEAD~1 HEAD | grep -E '^\.github/(workflows/.*\.yml|.*\.yml|.*\.yaml)$' || true)
          
          if [ -z "$CHANGED_FILES" ]; then
            echo "files=" >> $GITHUB_OUTPUT
          else
            FILES_LIST=$(echo "$CHANGED_FILES" | tr '\n' ' ')
            echo "files=$FILES_LIST" >> $GITHUB_OUTPUT
          fi
          
      - name: Process each branch
        run: |
          BRANCHES="${{ steps.params.outputs.branches }}"
          IFS=',' read -ra BRANCH_ARRAY <<< "$BRANCHES"
          
          # åˆ›å»ºåŒæ­¥æŠ¥å‘Š
          echo "## ğŸ“‹ å·¥ä½œæµåŒæ­¥æŠ¥å‘Š" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **æºåˆ†æ”¯**: develop" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒæ­¥æ–¹å¼**: ${{ steps.params.outputs.sync_method }}" >> $GITHUB_STEP_SUMMARY
          echo "- **åŒæ­¥å†…å®¹**: ${{ steps.params.outputs.sync_mode }}" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### åŒæ­¥ç»“æœ" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          for branch in "${BRANCH_ARRAY[@]}"; do
            branch=$(echo "$branch" | xargs)
            echo "ğŸ”„ Processing branch: $branch"
            
            # æ£€æŸ¥åˆ†æ”¯æ˜¯å¦å­˜åœ¨
            if ! git ls-remote --heads origin "$branch" | grep -q "$branch"; then
              echo "âš ï¸ Branch $branch does not exist, skipping"
              echo "- âš ï¸ **$branch**: åˆ†æ”¯ä¸å­˜åœ¨" >> $GITHUB_STEP_SUMMARY
              continue
            fi
            
            # å†³å®šåŒæ­¥æ–¹å¼
            SYNC_METHOD="${{ steps.params.outputs.sync_method }}"
            
            if [ "$SYNC_METHOD" = "auto" ]; then
              # æ£€æŸ¥åˆ†æ”¯ä¿æŠ¤ï¼ˆç®€å•åˆ¤æ–­ï¼šmainå’Œstagingé€šå¸¸æœ‰ä¿æŠ¤ï¼‰
              if [[ "$branch" =~ ^(main|staging)$ ]]; then
                SYNC_METHOD="pr"
              else
                SYNC_METHOD="direct"
              fi
            fi
            
            echo "Using sync method: $SYNC_METHOD for branch: $branch"
            
            if [ "$SYNC_METHOD" = "direct" ]; then
              # ç›´æ¥pushæ–¹å¼
              echo "ğŸ“¤ Direct push to $branch"
              
              git checkout "$branch"
              git pull origin "$branch"
              
              # åŒæ­¥æ–‡ä»¶
              if [ "${{ steps.params.outputs.sync_mode }}" = "all" ]; then
                git checkout develop -- .github/workflows/
                git checkout develop -- .github/*.yml 2>/dev/null || true
                git checkout develop -- .github/*.yaml 2>/dev/null || true
              else
                # Selectiveæ¨¡å¼
                IFS=',' read -ra FILES <<< "${{ github.event.inputs.workflow_files }}"
                for file in "${FILES[@]}"; do
                  file=$(echo "$file" | xargs)
                  if [ -n "$file" ]; then
                    [[ ! "$file" =~ ^\.github/ ]] && file=".github/workflows/$file"
                    git checkout develop -- "$file" 2>/dev/null || echo "File not found: $file"
                  fi
                done
              fi
              
              # æäº¤å¹¶æ¨é€
              if ! git diff --quiet; then
                git add .github/
                
                if [ "${{ github.event_name }}" = "push" ]; then
                  COMMIT_MSG="chore: åŒæ­¥å·¥ä½œæµæ›´æ–°ä» develop åˆ†æ”¯

è‡ªåŠ¨åŒæ­¥ä»¥ä¸‹å·¥ä½œæµå˜æ›´ï¼š
- ${{ steps.changed-files.outputs.files }}

Source: ${{ github.sha }}"
                else
                  COMMIT_MSG="chore: æ‰‹åŠ¨åŒæ­¥å·¥ä½œæµä» develop åˆ†æ”¯

åŒæ­¥æ¨¡å¼: ${{ steps.params.outputs.sync_mode }}
è§¦å‘è€…: @${{ github.actor }}"
                fi
                
                git commit -m "$COMMIT_MSG"
                git push origin "$branch"
                echo "- âœ… **$branch**: ç›´æ¥åŒæ­¥æˆåŠŸ" >> $GITHUB_STEP_SUMMARY
              else
                echo "- â„¹ï¸ **$branch**: æ— éœ€åŒæ­¥ï¼ˆå·²æ˜¯æœ€æ–°ï¼‰" >> $GITHUB_STEP_SUMMARY
              fi
              
            else
              # PRæ–¹å¼
              echo "ğŸ“ Creating PR for $branch"
              
              TIMESTAMP=$(date +%Y%m%d%H%M%S)
              SYNC_BRANCH="workflow-sync/$branch-$TIMESTAMP"
              
              git checkout -b "$SYNC_BRANCH" "origin/$branch"
              
              # åŒæ­¥æ–‡ä»¶ï¼ˆåŒä¸Šï¼‰
              if [ "${{ steps.params.outputs.sync_mode }}" = "all" ]; then
                git checkout develop -- .github/workflows/
                git checkout develop -- .github/*.yml 2>/dev/null || true
                git checkout develop -- .github/*.yaml 2>/dev/null || true
              else
                IFS=',' read -ra FILES <<< "${{ github.event.inputs.workflow_files }}"
                for file in "${FILES[@]}"; do
                  file=$(echo "$file" | xargs)
                  if [ -n "$file" ]; then
                    [[ ! "$file" =~ ^\.github/ ]] && file=".github/workflows/$file"
                    git checkout develop -- "$file" 2>/dev/null || echo "File not found: $file"
                  fi
                done
              fi
              
              # æ£€æŸ¥æ˜¯å¦æœ‰å˜æ›´
              if ! git diff --quiet; then
                git add .github/
                git commit -m "chore: åŒæ­¥å·¥ä½œæµä» develop åˆ° $branch"
                git push origin "$SYNC_BRANCH"
                
                # åˆ›å»ºPR
                PR_BODY="## ğŸ”„ å·¥ä½œæµåŒæ­¥è¯·æ±‚

### ğŸ“‹ åŒæ­¥è¯¦æƒ…
- **æºåˆ†æ”¯**: develop
- **ç›®æ ‡åˆ†æ”¯**: $branch
- **åŒæ­¥æ–¹å¼**: ${{ steps.params.outputs.sync_mode }}
- **è§¦å‘æ–¹å¼**: ${{ github.event_name }}

### âœ… æ£€æŸ¥æ¸…å•
- [ ] ç¡®è®¤å·¥ä½œæµå˜æ›´ç¬¦åˆé¢„æœŸ
- [ ] ç¡®è®¤ä¸ä¼šç ´åç›®æ ‡åˆ†æ”¯çš„ç‰¹å®šé…ç½®
- [ ] ç¡®è®¤æ‰€æœ‰å¿…éœ€çš„ secrets åœ¨ç›®æ ‡ç¯å¢ƒå¯ç”¨

---
*æ­¤ PR ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*"

                gh pr create \
                  --title "chore: åŒæ­¥å·¥ä½œæµåˆ° $branch åˆ†æ”¯" \
                  --body "$PR_BODY" \
                  --base "$branch" \
                  --head "$SYNC_BRANCH" \
                  --label "workflow-sync,automated"
                  
                echo "- ğŸ“ **$branch**: å·²åˆ›å»ºåŒæ­¥PR" >> $GITHUB_STEP_SUMMARY
              else
                echo "- â„¹ï¸ **$branch**: æ— éœ€åŒæ­¥ï¼ˆå·²æ˜¯æœ€æ–°ï¼‰" >> $GITHUB_STEP_SUMMARY
              fi
            fi
            
            # åˆ‡å›developå‡†å¤‡ä¸‹ä¸€ä¸ªåˆ†æ”¯
            git checkout develop
          done