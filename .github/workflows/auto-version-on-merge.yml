name: Auto Version on Merge

on:
  pull_request:
    types: [closed]
    branches:
      - test
      - staging
      - main

jobs:
  auto-version:
    if: github.event.pull_request.merged == true
    runs-on: ubuntu-latest
    permissions:
      contents: write
      pull-requests: write
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || github.token }}
          
      - name: Check for release marker
        id: check
        run: |
          if [ -f ".release-pending.json" ]; then
            echo "found=true" >> $GITHUB_OUTPUT
            RELEASE_TYPE=$(jq -r '.release_type' .release-pending.json)
            echo "release_type=$RELEASE_TYPE" >> $GITHUB_OUTPUT
            echo "Found release marker with type: $RELEASE_TYPE"
          else
            echo "found=false" >> $GITHUB_OUTPUT
            echo "No release marker found, skipping version upgrade"
          fi
          
      - name: Setup pnpm
        if: steps.check.outputs.found == 'true'
        uses: pnpm/action-setup@v4
        with:
          version: 10
          
      - name: Setup Node.js
        if: steps.check.outputs.found == 'true'
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'
          
      - name: Install dependencies
        if: steps.check.outputs.found == 'true'
        run: pnpm install --frozen-lockfile
        
      - name: Configure Git
        if: steps.check.outputs.found == 'true'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          
      - name: Execute version upgrade
        if: steps.check.outputs.found == 'true'
        run: |
          echo "Executing version upgrade with type: ${{ steps.check.outputs.release_type }}"
          
          # åˆ é™¤æ ‡è®°æ–‡ä»¶
          rm .release-pending.json
          git add .release-pending.json
          git commit -m "chore: remove release marker" || true
          
          # æ‰§è¡Œç‰ˆæœ¬å‡çº§
          if [ "${{ steps.check.outputs.release_type }}" = "auto" ]; then
            pnpm release:version
          else
            pnpm release:version:${{ steps.check.outputs.release_type }}
          fi
          
          # è·å–æ–°ç‰ˆæœ¬å·
          NEW_VERSION=$(node -p "require('./package.json').version")
          echo "NEW_VERSION=$NEW_VERSION" >> $GITHUB_ENV
          
      - name: Push version changes
        if: steps.check.outputs.found == 'true'
        run: |
          # æ¨é€æ›´æ”¹
          git push origin ${{ github.event.pull_request.base.ref }}
          
          # åˆ›å»ºç‰ˆæœ¬æ ‡ç­¾
          git tag -a "v${{ env.NEW_VERSION }}" -m "Release v${{ env.NEW_VERSION }}"
          git push origin "v${{ env.NEW_VERSION }}"
          
      - name: Comment on PR
        if: steps.check.outputs.found == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const comment = `âœ… **ç‰ˆæœ¬å‡çº§å·²å®Œæˆ**
            
            - æ–°ç‰ˆæœ¬: \`${{ env.NEW_VERSION }}\`
            - ç‰ˆæœ¬æ ‡ç­¾: \`v${{ env.NEW_VERSION }}\`
            - CHANGELOGå·²æ›´æ–°
            
            å‘å¸ƒæµç¨‹å°†è‡ªåŠ¨è§¦å‘...`;
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: context.issue.number,
              body: comment
            });
            
      - name: Create back-merge PR
        if: steps.check.outputs.found == 'true' && github.event.pull_request.base.ref == 'test'
        uses: actions/github-script@v7
        with:
          script: |
            try {
              // åˆ›å»ºå›åˆå¹¶PR
              const { data: pr } = await github.rest.pulls.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: `chore: sync version ${process.env.NEW_VERSION} back to develop`,
                head: 'test',
                base: 'develop',
                body: `## ğŸ”„ ç‰ˆæœ¬åŒæ­¥
                
                å°† test åˆ†æ”¯çš„ç‰ˆæœ¬æ›´æ–°åŒæ­¥å› develop åˆ†æ”¯ã€‚
                
                ### ğŸ“¦ åŒæ­¥å†…å®¹
                - ç‰ˆæœ¬å·: \`${process.env.NEW_VERSION}\`
                - CHANGELOG.md æ›´æ–°
                
                ### âš¡ è‡ªåŠ¨åˆå¹¶
                æ­¤ PR å°†åœ¨æ£€æŸ¥é€šè¿‡åè‡ªåŠ¨åˆå¹¶ã€‚
                
                ---
                *ç”± GitHub Actions è‡ªåŠ¨åˆ›å»º*`
              });
              
              console.log(`Created back-merge PR #${pr.number}`);
              
              // æ·»åŠ  auto-merge æ ‡ç­¾
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                labels: ['auto-merge', 'version-sync']
              });
            } catch (error) {
              if (error.status === 422) {
                console.log('Back-merge PR already exists or no changes to merge');
              } else {
                throw error;
              }
            }