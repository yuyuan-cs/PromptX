name: PR Merged to Develop Event

on:
  pull_request:
    types: [closed]
    branches:
      - develop
      - dev

jobs:
  trigger-release-preview:
    # Only trigger for actual PR merges, not direct pushes, and skip bot-triggered events
    if: |
      github.event.pull_request.merged == true && 
      github.event.pull_request.number != null &&
      github.actor != 'github-actions[bot]' &&
      github.actor != 'dependabot[bot]'
    runs-on: ubuntu-latest
    permissions:
      issues: write
      pull-requests: write
      contents: read
      
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          ref: ${{ github.event.pull_request.base.ref }}
          fetch-depth: 0
          
          
      - name: Check for changesets
        id: check
        run: |
          # Check if there are any changesets
          CHANGESET_COUNT=0
          
          if [ -d ".changeset" ]; then
            # Count markdown files (excluding README.md)
            for file in .changeset/*.md; do
              if [ -f "$file" ] && [ "$(basename "$file")" != "README.md" ]; then
                CHANGESET_COUNT=$((CHANGESET_COUNT + 1))
              fi
            done
          fi
          
          echo "changeset_count=$CHANGESET_COUNT" >> $GITHUB_OUTPUT
          
          if [ $CHANGESET_COUNT -gt 0 ]; then
            echo "has_changesets=true" >> $GITHUB_OUTPUT
            echo "‚úÖ Found $CHANGESET_COUNT changeset(s)"
          else
            echo "has_changesets=false" >> $GITHUB_OUTPUT
            echo "‚ÑπÔ∏è No changesets found"
          fi
          
      - name: Post merge notification
        uses: actions/github-script@v7
        with:
          # Use PAT_TOKEN if available for consistency
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const changesetCount = '${{ steps.check.outputs.changeset_count }}';
            const hasChangesets = '${{ steps.check.outputs.has_changesets }}' === 'true';
            
            let message = `## üéâ Pull Request Merged!
            
            **PR #${pr.number}** has been successfully merged into \`${pr.base.ref}\`.
            `;
            
            if (hasChangesets) {
              message += `
              ### üì¶ Release Status
              Found **${changesetCount} changeset(s)** ready for release.
              
              Let me show you what will be included in the next release...`;
            } else {
              message += `
              ### ‚ÑπÔ∏è No Changesets Found
              This PR doesn't include any changesets. No version bump will occur.`;
            }
            
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: message
            });
            
      - name: Trigger release preview
        if: steps.check.outputs.has_changesets == 'true'
        uses: actions/github-script@v7
        with:
          # Use PAT_TOKEN if available to trigger subsequent workflows
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            // Wait a moment for the notification to be posted
            await new Promise(resolve => setTimeout(resolve, 1000));
            
            // Post the start release preview command
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: '/start release --preview'
            });
            
            console.log(`‚úÖ Triggered /start release --preview for merged PR #${pr.number}`);
            
      - name: Auto-deploy dev version
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            
            // Wait for start release to complete
            console.log('‚è≥ Waiting for version bump to complete...');
            await new Promise(resolve => setTimeout(resolve, 5000));
            
            // Check if we should skip deployment
            const skipDeploy = pr.body && (
              pr.body.includes('[skip-deploy]') || 
              pr.body.includes('[skip-publish]')
            );
            
            if (skipDeploy) {
              console.log('‚è≠Ô∏è Skipping auto-deploy (found skip flag)');
              await github.rest.issues.createComment({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: pr.number,
                body: `‚è≠Ô∏è Auto-deployment skipped (found [skip-deploy] flag)`
              });
              return;
            }
            
            // Always deploy npm package for PromptX project
            console.log('üì¶ Triggering automatic NPM deployment to dev tag...');
            
            // Post the deploy command
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: '/deploy npm --tag dev --auto'
            });
            
            console.log(`‚úÖ Triggered npm dev deployment for PR #${pr.number}`);
            
            // Post summary
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: `## üöÄ Automated Release Pipeline Triggered\n\nüìã **Actions performed:**\n1. ‚úÖ Version bumped via \`/start release --preview\`\n2. ‚úÖ NPM deployment triggered with \`dev\` tag\n3. üì¶ Package will be published to:\n   - NPM Registry: https://www.npmjs.com/package/@promptx/cli\n   - GitHub Packages: https://github.com/Deepractice/PromptX/packages\n\nüîÑ **Status:** In progress...`
            });
            
      - name: Delete feature branch
        if: github.event.pull_request.merged == true
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.PAT_TOKEN || secrets.GITHUB_TOKEN }}
          script: |
            const pr = context.payload.pull_request;
            const branchName = pr.head.ref;
            
            // Only delete feature/fix/docs/chore branches
            if (branchName.match(/^(feature|fix|docs|chore)\//)) {
              try {
                await github.rest.git.deleteRef({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  ref: `heads/${branchName}`
                });
                console.log(`‚úÖ Deleted branch ${branchName}`);
                
                // Post comment about branch deletion
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: pr.number,
                  body: `üóëÔ∏è Branch \`${branchName}\` has been deleted.`
                });
              } catch (error) {
                console.log(`‚ö†Ô∏è Could not delete branch ${branchName}: ${error.message}`);
              }
            } else {
              console.log(`‚ÑπÔ∏è Keeping branch ${branchName} (not a feature/fix/docs/chore branch)`);
            }