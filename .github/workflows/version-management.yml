name: Version Management

on:
  workflow_dispatch:
    inputs:
      target_branch:
        description: 'Target branch to create version PR (test/staging/main)'
        required: true
        default: 'test'
        type: choice
        options:
          - test
          - staging
          - main
      release_type:
        description: 'Release type (auto/patch/minor/major)'
        required: true
        default: 'auto'
        type: choice
        options:
          - auto
          - patch
          - minor
          - major

permissions:
  contents: write
  pull-requests: write

jobs:
  prepare-version:
    name: Prepare Version Release
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          token: ${{ secrets.GH_PAT || github.token }}
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v4
        with:
          version: 10
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: '20.x'
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Configure Git
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
      
      - name: Create version branch
        run: |
          TIMESTAMP=$(date +%Y%m%d%H%M%S)
          BRANCH_NAME="chore/release-${TIMESTAMP}"
          git checkout -b $BRANCH_NAME
          echo "BRANCH_NAME=$BRANCH_NAME" >> $GITHUB_ENV
      
      - name: Create release marker
        run: |
          # åˆ›å»ºæ ‡è®°æ–‡ä»¶ï¼ŒåŒ…å«å‘å¸ƒä¿¡æ¯
          cat > .release-pending.json << EOF
          {
            "release_type": "${{ github.event.inputs.release_type }}",
            "target_branch": "${{ github.event.inputs.target_branch }}",
            "triggered_by": "${{ github.actor }}",
            "triggered_at": "$(date -u +%Y-%m-%dT%H:%M:%SZ)"
          }
          EOF
          
          git add .release-pending.json
          git commit -m "chore: prepare release to ${{ github.event.inputs.target_branch }} [${{ github.event.inputs.release_type }}]"
      
      - name: Push version branch
        run: |
          git push origin ${{ env.BRANCH_NAME }}
        env:
          GITHUB_TOKEN: ${{ secrets.GH_PAT || github.token }}
      
      - name: Create Pull Request
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GH_PAT || github.token }}
          script: |
            const { data: pr } = await github.rest.pulls.create({
              owner: context.repo.owner,
              repo: context.repo.repo,
              title: `chore: prepare release to ${{ github.event.inputs.target_branch }} [${{ github.event.inputs.release_type }}]`,
              head: `${{ env.BRANCH_NAME }}`,
              base: '${{ github.event.inputs.target_branch }}',
              body: `## ğŸš€ ç‰ˆæœ¬å‘å¸ƒå‡†å¤‡
              
              æ­¤PRå°†åœ¨åˆå¹¶æ—¶è‡ªåŠ¨æ‰§è¡Œç‰ˆæœ¬å‡çº§å’Œå‘å¸ƒã€‚
              
              ### ğŸ“‹ å‘å¸ƒä¿¡æ¯
              - **ç›®æ ‡åˆ†æ”¯**: ${{ github.event.inputs.target_branch }}
              - **å‘å¸ƒç±»å‹**: ${{ github.event.inputs.release_type }}
              - **è§¦å‘è€…**: @${{ github.actor }}
              
              ### â³ ç­‰å¾…é¢„è§ˆ
              GitHub Actions å°†åœ¨å‡ ç§’å†…ç”Ÿæˆç‰ˆæœ¬å˜æ›´é¢„è§ˆ...
              
              ### âœ… åˆå¹¶åå°†è‡ªåŠ¨æ‰§è¡Œ
              1. æ ¹æ®commitå†å²è®¡ç®—ç‰ˆæœ¬å·
              2. ç”ŸæˆCHANGELOG.md  
              3. æäº¤ç‰ˆæœ¬å˜æ›´
              4. è§¦å‘å¯¹åº”çš„å‘å¸ƒæµç¨‹
              
              ### ğŸ”„ å‘å¸ƒæµç¨‹
              - åˆå¹¶åˆ° \`test\` â†’ è§¦å‘ \`npm-alpha-release.yml\` â†’ å‘å¸ƒ \`alpha\` ç‰ˆæœ¬
              - åˆå¹¶åˆ° \`staging\` â†’ è§¦å‘ \`npm-beta-release.yml\` â†’ å‘å¸ƒ \`beta\` ç‰ˆæœ¬
              - åˆå¹¶åˆ° \`main\` â†’ è§¦å‘ \`npm-latest-release.yml\` â†’ å‘å¸ƒæ­£å¼ç‰ˆæœ¬
              
              > âš ï¸ **æ³¨æ„**: è¯·ç­‰å¾…ç‰ˆæœ¬é¢„è§ˆç”Ÿæˆåå†å®¡æ ¸æ­¤PR`
            });
            
            console.log(`Created PR #${pr.number}: ${pr.html_url}`);